## FIXME Rename to plotCountsPerCell
## FIXME Move to acidplots.



#' @name plotUMIsPerCell
#' @author Michael Steinbaugh, Rory Kirchner
#' @include globals.R
#' @inherit bioverbs::plotUMIsPerCell
#' @note Updated 2019-08-08.
#'
#' @inheritParams acidroxygen::params
#' @param point `character(1)`.
#'   Label either the "`knee`" or "`inflection`" points per sample. To disable,
#'   use "`none`". Requires `geom = "ecdf"`.
#' @param ... Additional arguments.
#'
#' @examples
#' data(indrops)
#' plotUMIsPerCell(indrops, geom = "violin")
#' plotUMIsPerCell(indrops, geom = "ridgeline")
#' plotUMIsPerCell(indrops, geom = "ecdf")
#' plotUMIsPerCell(indrops, geom = "histogram")
#' plotUMIsPerCell(indrops, geom = "boxplot")
NULL



#' @rdname plotUMIsPerCell
#' @name plotUMIsPerCell
#' @importFrom bioverbs plotUMIsPerCell
#' @usage plotUMIsPerCell(object, ...)
#' @export
NULL



## Updated 2019-07-24.
`plotUMIsPerCell,bcbioSingleCell` <-  # nolint
    function(
        object,
        geom,
        interestingGroups = NULL,
        min = 0L,
        max = Inf,
        point = c("none", "inflection", "knee"),
        trans = "log10",
        color,
        fill,
        title = "UMIs per cell"
    ) {
        assert(isString(title, nullOK = TRUE))
        geom <- match.arg(geom)
        point <- match.arg(point)

        ## Override `interestingGroups` argument when labeling points.
        if (point != "none") {
            interestingGroups <- "sampleName"
        }

        p <- do.call(
            what = .plotQCMetric,
            args = list(
                object = object,
                ## Note that this was changed in v0.3.19 to better match
                ## conventions used in Chromium and Seurat packages.
                metricCol = "nCount",
                geom = geom,
                interestingGroups = interestingGroups,
                min = min,
                max = max,
                trans = trans,
                color = color,
                fill = fill
            )
        )

        ## Calculate barcode ranks and label inflection or knee points.
        if (point != "none") {
            ## Require ecdf geom for now
            assert(identical(geom, "ecdf"))

            if (length(title)) {
                p <- p + labs(subtitle = paste(point, "point per sample"))
            }

            sampleNames <- sampleNames(object)

            ranks <- barcodeRanksPerSample(object)
            ## Inflection or knee points per sample.
            points <- lapply(
                X = ranks,
                FUN = function(x) {
                    assert(is(x, "DataFrame"))
                    out <- metadata(x)[[point]]
                    assert(is.numeric(out))
                    out
                }
            )
            points <- unlist(points)
            names(points) <- names(ranks)

            assert(identical(names(sampleNames), names(points)))

            if (geom == "ecdf") {
                ## Calculate the y-intercept per sample.
                freq <- mapply(
                    sampleID = names(points),
                    point = points,
                    MoreArgs = list(metrics = metrics(object)),
                    FUN = function(metrics, sampleID, point) {
                        nUMI <- metrics[
                            metrics[["sampleID"]] == sampleID,
                            "nCount",
                            drop = TRUE
                        ]
                        e <- ecdf(sort(nUMI))
                        e(point)
                    },
                    SIMPLIFY = TRUE,
                    USE.NAMES = TRUE
                )
                pointData <- data.frame(
                    x = points,
                    y = freq,
                    label = paste0(sampleNames, " (", points, ")"),
                    sampleName = sampleNames
                )
                p <- p +
                    geom_point(
                        data = pointData,
                        mapping = aes(
                            x = !!sym("x"),
                            y = !!sym("y"),
                            color = !!sym("sampleName")
                        ),
                        size = 5L,
                        show.legend = FALSE
                    ) +
                    acid_geom_label_repel(
                        data = pointData,
                        mapping = aes(
                            x = !!sym("x"),
                            y = !!sym("y"),
                            label = !!sym("label"),
                            color = !!sym("sampleName")
                        )
                    )
            }
        }

        p <- p + labs(title = title)

        p
    }

formals(`plotUMIsPerCell,bcbioSingleCell`)[c("color", "fill")] <-
    formalsList[c("color.discrete", "fill.discrete")]
formals(`plotUMIsPerCell,bcbioSingleCell`)[["geom"]] <- geom



#' @rdname plotUMIsPerCell
#' @export
setMethod(
    f = "plotUMIsPerCell",
    signature = signature("bcbioSingleCell"),
    definition = `plotUMIsPerCell,bcbioSingleCell`
)
